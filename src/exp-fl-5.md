# exp-fl-5: 訓練途中のモデルを利用してFLベンチマークを作成した上での評価

Paoloとの打ち合わせを受けて発生．
exp-fl-4とは別のFLの実験．
FL for DNNは評価のベンチマークがないので間接的になりがち．そこを解決するために，学習途中のエポックでできたモデルにFLを行う．
そして，FLで特定された重みと，実際に学習で更新された重みがどれくらい近いかを見ることでFLの評価とする．
FLが学習にalignしている感じがするが，real faultsを特定するという感じがする．

## 実験方法
今回は2epoch学習している．なので，1epoch目の学習結果のモデルに対してFLを行うことになる．

# 必要なスクリプト
- `exp-fl-5-1.py`: M1からM2に進化する時に変更された重みを確認 (各重み値に対して変更前後の差の絶対値を取ってランキング)．これにより，FLのベンチマークを作成できる．
    - 将来変更されるべきをFLで予測できるか，というのがポイント．
- `exp-fl-5-2.py`: M1に対する誤分類の種類とか色々を取得する (misclf_info)
    - 結果は `exp-fl-5/c100_fold{k}` 以下に保存される．
- `exp-fl-5-3.py`: 各種法の適用のために，各サンプルに対するFFN直前のLayerNorm前の状態とFFNの中間状態をキャッシュとして保存する．実行時間などは `src/out_vit_c100_fold0/logs/exp-fl-5-3.log` から確認できる．
- M1に全てのFL手法を適用する
    - neuron-level: random (`exp-fl-5-7.py`), ig (`exp-fl-5-4.py`), vdiff (`exp-fl-5-6.py`), vdiff+mean_act (`exp-fl-5-6.py`)
    - weight-level: random (`exp-fl-5-7.py`), bl (`exp-fl-5-5.py`), vdiff (`exp-fl-5-6.py`), vdiff+mean_act+grad_loss (`exp-fl-5-6.py`)
        - nを指定した場合はそれがファイル名からわかるようにしたい．nを指定しない場合はnの情報をファイル名から落とすことで，そのこともわかるようにしたい．
    - ここで忘れずに各手法の時間を測りたい．`exp-fl-X-Y_time.csv` の形式で保存しておく．
- vdiff+mean_act+grad_loss (`exp-fl-5-6.py`)について：
    - Vdiffとmean_actによるニューロン特定 -> grad_lossも使った重み特定をやる
    - 保存したいもの：cor, mis時のvscore, mean_act (mis時のみ), 各重みに対するgrad_lossのnpy
- `exp-fl-5-7.py`: 5-1で作ったFLのGTと5-4~6で得られた結果を比較して一致率などを出すためのスクリプト．
    - ランダムな位置特定はやる必要がある？ランダムに特定した場合の期待値は計算できる．


## 評価方法
### o1へのプロンプト
現在，Transformerネットワークの最終レイヤのFFNに対する重みのバグ限局を研究しています．
以下に，FL手法の適用方法，評価用ground truthの設定方法を示すので，それを用いたFL手法ごとの比較評価方法を，ソフトウェア工学のトップジャーナルへ掲載する実験であることを踏まえて考えてください．

# FL手法の適用方法
対象FFNの重み行列は2つあり，1つめは768次元状態ベクトルを3072次元に変換するもの (Wbef)，もう1つは3072次元状態ベクトルを768次元状態ベクトルに変換するもの(Waft)です．
各重みに対してあるFL手法FL_iは疑惑値を計算します．より具体的には，Susp(Wbef), Susp(Waft)を纏めた集合に対してランキングをつけて降順に並べます．
言い換えると，Wbef, Waftに含まれる各重み値に対してランキングが付与されます．ランキングの最小値は1で，最大値は (Wbefの要素数) + (Waftの要素数) です．
例えば，上位40件の重みを取得したい場合は，このランキングが上位40件の重みだけを取り出します．

# 評価用ground truthの設定方法
対象のTransformerモデルは，(最終エポック-1) epoch後のモデルです．このモデルの重みを最終エポックのモデルと比較します
diff_bef = Wbef_new - Wbef_old, diff_aft = Waft_new - Waft_old です．diff_befとdiff_aftを一つの配列にまとめて，絶対値が大きい順にランキングをつけます．
その結果，重み値ごとにランキングが付与できます．これをFLのground truthとして扱います．

このような状況で，ground truthを使っていろんなFL手法の評価をする方法を知りたいです．

## 実験結果

現在TransformerのAttentionの後のFFNレイヤの2つの重み（768->3072に変換する重みと，3072->768に変換する重み）に対するFault Localizationを実装しました．
FL手法は，疑惑スコアでソートされた重みのインデックスのリストを返します．