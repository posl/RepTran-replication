これに関するrepairの実験は全て `exp-repair-3-{実験サブID}` という形式でレポジトリに対応させる．
スクリプトのファイル名は `exp-repair-3-{実験サブID}-{スクリプトID}.py` とする．
これらのTODOは [[20250514亀井先生mtg]] を受けてまとめたもの．

> [!NOTE] このページでタスク管理風なこともしたい．
> 🥚 : 未着手
> 🏃 : 実行中
> 🏝️ : 実装は終わって実行待ち
> ✅ : 完了

# RQ2でやること：重み数を変更した場合のrepair性能
## モチベーション
RQ1ではArachneのオリジナルと公平に比較するために，重み数が $N_{avg}$ で固定だった．
なのでこのRQではその制約をとっぱらい，重み数を変えた実験をする．
## 重み数の設定方法
最終レイヤのFFN層の重み数は合計2x3072x768 = 4,718,592
これの0.01% = 471.8592なのでとりあえず472個にしてみる？
1%でも47,185.92なので少し多い．

| $r_{weight}$ | $N_{weight}$ |
| ------------:| ------------:|
|       0.005% |          236 |
|        0.01% |          472 |
|        0.02% |          944 |
|         0.1% |         4719 |
|           1% |        47186 |
上の表から，**0.005%, 0.01%, 0.02%** を採用するのが合理的な気がする．
1,000を超えると計算量的にrepairのユースケースと合わないかも．
## Arachneの変更
Paretoフロントを取らずスコアの平均を取ることで重み数をコントロールできるように改造したArachneを，ArachneV3と呼ぶ (arXiv, TOSEMがそれぞれV1, V2という想定)．

# `exp-repair-4-1`
## 目的
Ours, ArachneV3, Randomの3種類の手法を上の重み数の設定で実行する．
## ステップ
### ステップ1：FLの実行 ✅
Ours, ArachneV3のFLを実行して重み位置情報を保存．
#### ステップ1-1: Ours ✅
- Oursで重み数を変えてFL実行
- `exp-repair-3-2-1.py` で重み数が11だったのを，上の表からとった3つの数字のリストに変えるだけ．
- 該当スクリプト: `exp-repair-4-1-1.py`
#### ステップ1-2: ArachneV3 ✅
- `exp-repair-4-1-1.py` からニューロンスコアの重み付け処理 (betaが関わる部分) を削除したバージョン．
- 該当スクリプト: `exp-repair-4-1-2.py`
### ステップ2：Repairの実行 ✅
各手法ごと，重み数ごとにrepairを回す．
- $\alpha$ の値はArachneの原論文と同じ10に限る．違う値に関しては別のRQで調べる．
- ランダムの位置特定は3-2-2の中でやることにして位置の保存までやる．
- 実行に見積もり45時間くらいかかる泣
	- 1回のrunは400sec.
	- misclf_type, fpfn, tgt_rankの組み合わせが合計9通り
	- repsが5回
	- w_num (重み数) が3通り
	- 手法が3つ
	- 合計= 400sec x 9 x 5 x 3 x 3 = 45h (1.875 日)
	- ↑はc100の場合で，tiny-imagenetなら800sec程度がベースなので90h = 3.75日
		- 実際は 4824m24.276s = 80.4h でした
- 実装上の注意：repair時のログをステップごとに出すとログファイルのためだけにめっちゃストレージを食うので，次回以降はログに出力する部分を減らしたい
- バグを見つけてしまいました．exp-repair-3 と違ってrepair結果のファイルにも wnum を含めないといけない
	- `exp-repair-3` は重み数固定なので wnum をファイル名に含めなくてもトレースできた．
	- 今回は重み数3通りなのでそれを記録しておかないといけない
- 該当スクリプト: `exp-repair-4-1-3.py` (メイン処理の定義), `exp-repair-4-1-4.py` (メイン処理をいろんな設定で呼び出して実行)
### ステップ3：テストセットで評価してデータ記録 🏃
- 結果の可視化の方法を考えておく必要がある
- jsonファイルにメトリクスを書き込んでいくという点は [[20250528作成 - RQ1 - TOSEM投稿に向けた実験TODO#ステップ3：テストセットで評価してデータ記録 ✅]] と同じ．
- 該当スクリプト: `exp-repair-4-1-5.py` (メイン処理の定義), `exp-repair-4-1-6.py` (メイン処理をいろんな設定で呼び出して実行)
### ステップ4：記録したデータを図表にまとめて可視化 
- `exp-repair-4-1-7.py` で作図（棒グラフとline plot)
- `exp-repair-4-1-8.py` で統計検定の結果の表を1テーブルにまとめる

# 進捗表

| ステップ | サブタスク             | スクリプト名                         | C100 | tiny-imagenet |
| ---- | ----------------- | ------------------------------ | ---- | ------------- |
| 1    | FL実行（Ours）        | `exp-repair-4-1-1.py`          | ✅    | ✅             |
|      | FL実行（ArachneV3）   | `exp-repair-4-1-2.py`          | ✅    | ✅             |
| 2    | Repair処理（全手法・全設定） | `exp-repair-4-1-3.py`, `-4.py` | ✅    | ✅             |
| 3    | テストセットで評価・記録      | `exp-repair-4-1-5.py`, `-6.py` | ✅    | ✅             |
| 4    | 結果の図表化と可視化        | `exp-repair-4-1-7.py`, `-8.py` | ✅    | ✅             |
|      |                   |                                |      |               |
